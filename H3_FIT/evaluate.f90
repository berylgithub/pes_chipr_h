!######################################################################################################
! caller (evaluator):
!% For diatomics:
!CALL CHIPR_DIAT(R,POT,DER,DVDR) 
!% For three-body energies
!CALL CHIPR_TRIAT(R,POT,DER,DVDR) 
!% For four-body energies
!CALL CHIPR_TETRA(R,POT,DER,DVDR)

program evaluator
    IMPLICIT NONE  
    DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE :: R_train_array, R_test_array
    DOUBLE PRECISION, DIMENSION(:), ALLOCATABLE :: V_train_array, V_test_array, V_pred_train_array, V_pred_test_array
    DOUBLE PRECISION :: rmse_train, rmse_test
    DOUBLE PRECISION, DIMENSION(3) :: DVDR = 0.0
    LOGICAL :: DER = .false.
    INTEGER :: i, nlines

    ! train data eval:
    !load train data only from file:
    nlines = 0
    open (1, file = 'abinitio_data.txt')
    do
        read (1,*, END=10)
        nlines = nlines + 1
    end do
    10 close (1)
    ALLOCATE(R_train_array(nlines, 3))
    ALLOCATE(V_train_array(nlines))
    ALLOCATE(V_pred_train_array(nlines))
    open (1, file = 'abinitio_data.txt')
    do i=1, nlines
        read(1,*) R_train_array(i, :), V_train_array(i)
    end do
    close (1)
    !evaluate each point:
    do i=1, nlines
        call CHIPR_TRIAT(R_train_array(i, :), V_pred_train_array(i), DER, DVDR)
    end do
    !compute RMSE:
    rmse_train = RMSE(V_train_array, V_pred_train_array)

    ! test data eval:
    !load test data only from file:
    nlines = 0
    open (1, file = 'test_data.txt')
    do
        read (1,*, END=11)
        nlines = nlines + 1
    end do
    11 close (1)
    ALLOCATE(R_test_array(nlines, 3))
    ALLOCATE(V_test_array(nlines))
    ALLOCATE(V_pred_test_array(nlines))
    open (1, file = 'test_data.txt')
    do i=1, nlines
        read(1,*) R_test_array(i, :), V_test_array(i)
    end do
    close (1)
    !evaluate each point:
    do i=1, nlines
        call CHIPR_TRIAT(R_test_array(i, :), V_pred_test_array(i), DER, DVDR)
    end do
    !compute RMSE:
    rmse_test = RMSE(V_test_array, V_pred_test_array)
    !save evaluated points to file:
    open(1, file = "pred_data.txt")
    do i=1, nlines
        write(1, *) R_test_array(i, :), V_pred_test_array(i)
    end do
    write(1, *) "#RMSE (train, test):"
    write(1, *) rmse_train, rmse_test
    close(1)

    contains
    FUNCTION RMSE(X, Y) RESULT(rmse_var)
        IMPLICIT NONE
        DOUBLE PRECISION, DIMENSION(:) :: X, Y
        DOUBLE PRECISION :: rmse_var, N

        N = size(X)
        rmse_var = SQRT(SUM((X-Y)**2)/N)
    END FUNCTION RMSE

end program evaluator
!######################################################################################################

      SUBROUTINE CHIPR_TRIAT(R,POT,DER,DVDR)
      IMPLICIT NONE
      CHARACTER(LEN=3), PARAMETER :: MOLTYP="A3"
      INTEGER, PARAMETER :: DEG=1
      INTEGER, PARAMETER :: NC=705
      INTEGER, PARAMETER :: NX=3
      INTEGER :: I,J,K,L,M,S,O,ID
      INTEGER :: POLORDER
      INTEGER, DIMENSION(DEG) :: BSORDER,NCBAS
      DOUBLE PRECISION, DIMENSION(NC) :: C
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: POL,BS
      DOUBLE PRECISION, DIMENSION(3) :: R
      DOUBLE PRECISION :: POT,REPDAMP
      INTEGER :: NCPOL,NCTOTAL,SUMC
      DOUBLE PRECISION, DIMENSION(NX) :: Y
      INTEGER :: TOTNUM,MNUM
      INTEGER, DIMENSION(3,6) :: P
      LOGICAL :: DER
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY1
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY2
      DOUBLE PRECISION, ALLOCATABLE, DIMENSION(:) :: DVDY3
      DOUBLE PRECISION, DIMENSION(NX) :: DVDR,DYDR

      C(  1)=  0.46508295057480552259221440181136131D+03
      C(  2)= -0.84611904688514787267195060849189758D+04
      C(  3)= -0.99453427529353903082665055990219116D+04
      C(  4)=  0.49246600620170247566420584917068481D+05
      C(  5)= -0.66606065899775121579295955598354340D+04
      C(  6)=  0.31052599236435600323602557182312012D+06
      C(  7)= -0.25801002477542788255959749221801758D+06
      C(  8)=  0.64584340425133227836340665817260742D+06
      C(  9)= -0.21441062144741015508770942687988281D+07
      C( 10)= -0.23245915821464885957539081573486328D+07
      C( 11)=  0.18763207046786940190941095352172852D+07
      C( 12)= -0.59748027641322677955031394958496094D+07
      C( 13)= -0.30219635455454350449144840240478516D+07
      C( 14)=  0.10697647386678434908390045166015625D+08
      C( 15)=  0.22913619235657289624214172363281250D+08
      C( 16)=  0.39681995797486118972301483154296875D+07
      C( 17)= -0.13418112035238485783338546752929688D+08
      C( 18)=  0.30587027209082648158073425292968750D+08
      C( 19)=  0.30251973960613299161195755004882812D+08
      C( 20)= -0.37838851942227669060230255126953125D+08
      C( 21)= -0.82870088299863651394844055175781250D+08
      C( 22)= -0.37381474993516027927398681640625000D+08
      C( 23)= -0.38046261228620126843452453613281250D+08
      C( 24)=  0.59085918457670092582702636718750000D+08
      C( 25)= -0.83807967806695058941841125488281250D+08
      C( 26)= -0.10546677726542419195175170898437500D+09
      C( 27)= -0.34335695190098829567432403564453125D+08
      C( 28)=  0.98864827186661362648010253906250000D+08
      C( 29)=  0.18452394655825993418693542480468750D+09
      C( 30)=  0.18145165433384630084037780761718750D+09
      C( 31)=  0.99234090797919228672981262207031250D+08
      C( 32)=  0.56267014188441313803195953369140625D+08
      C( 33)= -0.13491353540721222758293151855468750D+09
      C( 34)=  0.88884942126455113291740417480468750D+08
      C( 35)=  0.22684593220387184619903564453125000D+09
      C( 36)=  0.81086768949736416339874267578125000D+08
      C( 37)= -0.18906453699505534768104553222656250D+09
      C( 38)= -0.18301959592152509093284606933593750D+09
      C( 39)= -0.26690172237494167685508728027343750D+09
      C( 40)= -0.10854604592753159999847412109375000D+09
      C( 41)= -0.17810414671977064013481140136718750D+09
      C( 42)= -0.97422362190283596515655517578125000D+08
      C( 43)=  0.21594724522582527250051498413085938D+08
      C( 44)=  0.10379909304521307349205017089843750D+09
      C( 45)=  0.54293360783922925591468811035156250D+08
      C( 46)= -0.20930588445885401964187622070312500D+09
      C( 47)=  0.85350768825480282306671142578125000D+08
      C( 48)=  0.78886027666844213381409645080566406D+07
      C( 49)=  0.18602985797297549247741699218750000D+09
      C( 50)=  0.22167191153453071601688861846923828D+07
      C( 51)= -0.22454792508954077959060668945312500D+08
      C( 52)=  0.76634759586800009012222290039062500D+08
      C( 53)=  0.10559579988495132327079772949218750D+09
      C( 54)= -0.67842050073039233684539794921875000D+08
      C( 55)=  0.81475388077533334493637084960937500D+08
      C( 56)= -0.31094192612502795457839965820312500D+09
      C( 57)=  0.12704287836065192520618438720703125D+09
      C( 58)= -0.61126276568587638437747955322265625D+08
      C( 59)= -0.16277128309421536326408386230468750D+09
      C( 60)= -0.30990627047718840837478637695312500D+09
      C( 61)= -0.16702725423269289731979370117187500D+09
      C( 62)=  0.11120547113096207380294799804687500D+09
      C( 63)=  0.60053768379287876188755035400390625D+08
      C( 64)=  0.56307269598156654834747314453125000D+09
      C( 65)= -0.17778374454668808728456497192382812D+08
      C( 66)=  0.26998517480885195732116699218750000D+09
      C( 67)=  0.28413484042222684621810913085937500D+09
      C( 68)=  0.93766292612473636865615844726562500D+08
      C( 69)=  0.62833815020478844642639160156250000D+08
      C( 70)=  0.71316440082945728302001953125000000D+09
      C( 71)= -0.25317592779891584068536758422851562D+08
      C( 72)= -0.15626844262280479073524475097656250D+09
      C( 73)= -0.25533327424702340364456176757812500D+09
      C( 74)=  0.27264093524199056625366210937500000D+09
      C( 75)=  0.13779635756926670670509338378906250D+09
      C( 76)=  0.23910543908325251191854476928710938D+08
      C( 77)= -0.20934576598012289404869079589843750D+09
      C( 78)= -0.32566297577334392070770263671875000D+09
      C( 79)= -0.18839171125951015949249267578125000D+09
      C( 80)=  0.86189591240934938192367553710937500D+08
      C( 81)=  0.11153997538635268807411193847656250D+09
      C( 82)= -0.15519760112709182500839233398437500D+09
      C( 83)= -0.23666628461242285370826721191406250D+09
      C( 84)= -0.12659162029919840395450592041015625D+09
      C( 85)= -0.49613396674395376443862915039062500D+09
      C( 86)=  0.78852624448901489377021789550781250D+08
      C( 87)=  0.47700434507748529314994812011718750D+08
      C( 88)=  0.38399239911382049322128295898437500D+09
      C( 89)=  0.25203237979656884074211120605468750D+09
      C( 90)= -0.23912914938289356231689453125000000D+09
      C( 91)= -0.41488797835463382303714752197265625D+08
      C( 92)=  0.38886613405372315645217895507812500D+09
      C( 93)=  0.12742429734577371180057525634765625D+09
      C( 94)=  0.85710863685446262359619140625000000D+09
      C( 95)=  0.21151903305371749401092529296875000D+09
      C( 96)= -0.21817193619998469948768615722656250D+09
      C( 97)=  0.12201999212686057388782501220703125D+09
      C( 98)= -0.76033487812455761432647705078125000D+09
      C( 99)= -0.35286554367680191993713378906250000D+09
      C(100)=  0.12676226327704975381493568420410156D+08
      C(101)= -0.37162801494369441270828247070312500D+09
      C(102)= -0.45585235128839170932769775390625000D+09
      C(103)= -0.70629115175476014614105224609375000D+08
      C(104)= -0.77161351357173478603363037109375000D+09
      C(105)=  0.89142168152759388089179992675781250D+08
      C(106)= -0.68525172148304653167724609375000000D+09
      C(107)= -0.57371977279895353317260742187500000D+09
      C(108)=  0.41548519230780310928821563720703125D+08
      C(109)= -0.47931318723451232910156250000000000D+09
      C(110)=  0.88353560436080813407897949218750000D+08
      C(111)=  0.49749495905263060331344604492187500D+09
      C(112)=  0.16691494302004417777061462402343750D+09
      C(113)= -0.44433575993567287921905517578125000D+09
      C(114)=  0.61985662198867909610271453857421875D+08
      C(115)=  0.71542710738895773887634277343750000D+09
      C(116)=  0.22996609277336958050727844238281250D+09
      C(117)=  0.41604469433449804782867431640625000D+09
      C(118)=  0.83140280659969186782836914062500000D+09
      C(119)= -0.54894176304498040676116943359375000D+09
      C(120)= -0.50435531904763764142990112304687500D+09
      C(121)= -0.28077739340994608402252197265625000D+09
      C(122)=  0.17780874759317807853221893310546875D+08
      C(123)=  0.57551904165147155523300170898437500D+08
      C(124)=  0.68731978305391597747802734375000000D+09
      C(125)=  0.22207646161246143281459808349609375D+08
      C(126)=  0.12132918658138094842433929443359375D+09
      C(127)=  0.77487704768296444416046142578125000D+09
      C(128)= -0.81055530163821429014205932617187500D+08
      C(129)= -0.28156407933368444442749023437500000D+09
      C(130)= -0.43539847644809412956237792968750000D+09
      C(131)= -0.64477726963869965076446533203125000D+09
      C(132)= -0.11834917074334809780120849609375000D+10
      C(133)=  0.47280133768630057573318481445312500D+09
      C(134)=  0.53688014309795188903808593750000000D+09
      C(135)= -0.46833450289513635635375976562500000D+09
      C(136)= -0.22306940634229546785354614257812500D+09
      C(137)= -0.13047408043113515377044677734375000D+10
      C(138)= -0.70099021872501301765441894531250000D+09
      C(139)= -0.31760349649128254503011703491210938D+08
      C(140)=  0.58790527637866950035095214843750000D+09
      C(141)=  0.58323255492137920856475830078125000D+09
      C(142)=  0.36217651229008847475051879882812500D+09
      C(143)=  0.59890491098449730873107910156250000D+09
      C(144)= -0.12513767907011207938194274902343750D+09
      C(145)= -0.37028451688804191350936889648437500D+09
      C(146)=  0.41334568293967646360397338867187500D+09
      C(147)=  0.26862866597589850425720214843750000D+09
      C(148)=  0.11855878965101935863494873046875000D+10
      C(149)=  0.13166185734677238464355468750000000D+10
      C(150)=  0.38083419206886148452758789062500000D+09
      C(151)=  0.43664291284448474645614624023437500D+09
      C(152)=  0.57805733880446660518646240234375000D+09
      C(153)=  0.96397974894752299785614013671875000D+09
      C(154)=  0.57851928699014656245708465576171875D+08
      C(155)= -0.38322114464094781875610351562500000D+09
      C(156)=  0.10650582182534286975860595703125000D+10
      C(157)=  0.18518175960924243927001953125000000D+09
      C(158)= -0.20906752410314303636550903320312500D+09
      C(159)=  0.36054126188685041666030883789062500D+09
      C(160)= -0.29757008445662051439285278320312500D+09
      C(161)= -0.15200930898332593441009521484375000D+10
      C(162)=  0.91339491921898150444030761718750000D+09
      C(163)= -0.83257373529873752593994140625000000D+09
      C(164)= -0.15510433085611767768859863281250000D+10
      C(165)= -0.12196917345047199726104736328125000D+10
      C(166)= -0.91246294381717026233673095703125000D+09
      C(167)= -0.19097048920864814519882202148437500D+09
      C(168)= -0.11768550133149557113647460937500000D+10
      C(169)=  0.43747930954488116502761840820312500D+09
      C(170)=  0.16263076128475580215454101562500000D+10
      C(171)=  0.97610926589116024971008300781250000D+09
      C(172)= -0.15606083147175380587577819824218750D+09
      C(173)=  0.81504243639065161347389221191406250D+08
      C(174)= -0.53763529300913023948669433593750000D+09
      C(175)=  0.22152223700582876801490783691406250D+09
      C(176)=  0.15192345014903216361999511718750000D+10
      C(177)=  0.35822136553098154067993164062500000D+09
      C(178)= -0.35370035904336410760879516601562500D+09
      C(179)= -0.39626405529938733577728271484375000D+09
      C(180)= -0.30972091587351959943771362304687500D+09
      C(181)=  0.98421303413276803493499755859375000D+09
      C(182)= -0.34986830733753152191638946533203125D+08
      C(183)= -0.15855545669867008924484252929687500D+09
      C(184)=  0.16847341347813076972961425781250000D+10
      C(185)=  0.18595270284473886489868164062500000D+10
      C(186)=  0.19810874056701455116271972656250000D+10
      C(187)=  0.22589061597553682327270507812500000D+10
      C(188)= -0.42898226311702209711074829101562500D+09
      C(189)= -0.11296650342440421581268310546875000D+10
      C(190)= -0.18651272735259470939636230468750000D+10
      C(191)=  0.16256272224151599407196044921875000D+10
      C(192)=  0.90613327215331125259399414062500000D+09
      C(193)=  0.42868316765310448408126831054687500D+09
      C(194)=  0.45035751034585252404212951660156250D+08
      C(195)= -0.13497605911092491149902343750000000D+10
      C(196)= -0.11150009199607198238372802734375000D+10
      C(197)= -0.26986846304278798103332519531250000D+10
      C(198)= -0.46623779853987199068069458007812500D+09
      C(199)=  0.72377406318156147003173828125000000D+09
      C(200)=  0.10985767549869709014892578125000000D+10
      C(201)=  0.92693125396845018863677978515625000D+09
      C(202)=  0.69979850332948493957519531250000000D+09
      C(203)=  0.38617422517319226264953613281250000D+09
      C(204)= -0.11088039152209813594818115234375000D+10
      C(205)= -0.15991655082966263294219970703125000D+10
      C(206)=  0.24169118220340188592672348022460938D+08
      C(207)= -0.76161849205053377151489257812500000D+09
      C(208)= -0.12964868643534290790557861328125000D+10
      C(209)= -0.67893508977589797973632812500000000D+09
      C(210)= -0.22085443091151037216186523437500000D+10
      C(211)= -0.41117839159254521131515502929687500D+09
      C(212)= -0.20025653085790894031524658203125000D+10
      C(213)= -0.96888574952644276618957519531250000D+09
      C(214)=  0.48689787593259513378143310546875000D+09
      C(215)= -0.42466618950902217626571655273437500D+09
      C(216)=  0.43143417331893777847290039062500000D+09
      C(217)=  0.23249217210213298797607421875000000D+10
      C(218)=  0.19654403455463867187500000000000000D+10
      C(219)=  0.20193526048148436546325683593750000D+10
      C(220)= -0.12725262227187225818634033203125000D+10
      C(221)= -0.56448646616528224945068359375000000D+09
      C(222)=  0.20828949773711526393890380859375000D+09
      C(223)=  0.11290444913057951927185058593750000D+10
      C(224)=  0.11047393798826229572296142578125000D+10
      C(225)=  0.24772553189895033836364746093750000D+10
      C(226)=  0.39074348609815254211425781250000000D+10
      C(227)=  0.12905149543361945152282714843750000D+10
      C(228)= -0.20527307572300839424133300781250000D+09
      C(229)= -0.74988777002416348457336425781250000D+09
      C(230)= -0.13417753198884627819061279296875000D+10
      C(231)= -0.47840859529865074157714843750000000D+09
      C(232)= -0.15883663598440864086151123046875000D+10
      C(233)= -0.12786732209825618267059326171875000D+10
      C(234)=  0.39801715996307432651519775390625000D+09
      C(235)=  0.13121060331543121337890625000000000D+10
      C(236)=  0.16268762213691270351409912109375000D+10
      C(237)=  0.98512447793374049663543701171875000D+09
      C(238)= -0.18380101912955958843231201171875000D+10
      C(239)= -0.15136544151239278316497802734375000D+10
      C(240)= -0.20462723563182301521301269531250000D+10
      C(241)= -0.27355512053651680946350097656250000D+10
      C(242)= -0.77698338165137505531311035156250000D+09
      C(243)=  0.10986724736351447105407714843750000D+10
      C(244)= -0.26209984440201549530029296875000000D+10
      C(245)= -0.48543096227320718765258789062500000D+09
      C(246)= -0.38949112661327166557312011718750000D+10
      C(247)= -0.32063304178421454429626464843750000D+10
      C(248)=  0.10012463769812847375869750976562500D+10
      C(249)= -0.22445763264185481071472167968750000D+10
      C(250)= -0.28607546132732276916503906250000000D+10
      C(251)= -0.40182535638442941009998321533203125D+08
      C(252)=  0.19504600793356873989105224609375000D+10
      C(253)= -0.15580160891345469951629638671875000D+10
      C(254)= -0.19056924200613782405853271484375000D+10
      C(255)= -0.45227028533094396591186523437500000D+10
      C(256)= -0.10952240763571724891662597656250000D+10
      C(257)=  0.14330551097078487873077392578125000D+10
      C(258)=  0.48711529935138654708862304687500000D+10
      C(259)= -0.22867321780589181184768676757812500D+09
      C(260)= -0.93801419606091225147247314453125000D+09
      C(261)=  0.67445707137802767753601074218750000D+09
      C(262)=  0.46156765490529279708862304687500000D+10
      C(263)=  0.30889305715008215904235839843750000D+10
      C(264)=  0.32692692050957646369934082031250000D+10
      C(265)=  0.11372025963959681987762451171875000D+10
      C(266)=  0.31403819085985870361328125000000000D+10
      C(267)=  0.14911664862359352111816406250000000D+10
      C(268)= -0.26206157647383389472961425781250000D+10
      C(269)= -0.37405908446511082649230957031250000D+10
      C(270)= -0.19612954063313362598419189453125000D+10
      C(271)= -0.13029747782379705905914306640625000D+10
      C(272)=  0.58083450576487731933593750000000000D+09
      C(273)=  0.23917635813005838394165039062500000D+10
      C(274)=  0.55648494465695552825927734375000000D+10
      C(275)=  0.48503111127403271198272705078125000D+09
      C(276)= -0.83269390600259959697723388671875000D+09
      C(277)= -0.66798410999503684043884277343750000D+09
      C(278)= -0.25818565795170469284057617187500000D+10
      C(279)= -0.17445760376887474060058593750000000D+10
      C(280)=  0.22597344941414909362792968750000000D+10
      C(281)= -0.31837528017986607551574707031250000D+09
      C(282)=  0.32797375808650646209716796875000000D+10
      C(283)= -0.17054226423999190330505371093750000D+10
      C(284)= -0.43159850328260593414306640625000000D+10
      C(285)= -0.26101613399521878361701965332031250D+09
      C(286)=  0.29020485318769512176513671875000000D+10
      C(287)=  0.87066301696756303310394287109375000D+09
      C(288)= -0.29396179022095613479614257812500000D+10
      C(289)= -0.21192718851948888301849365234375000D+10
      C(290)=  0.75876332707861387729644775390625000D+09
      C(291)= -0.30432010289332909584045410156250000D+10
      C(292)= -0.45477105924946231842041015625000000D+10
      C(293)= -0.53782298465541267395019531250000000D+10
      C(294)= -0.10436501185841707229614257812500000D+11
      C(295)=  0.81520178604801356792449951171875000D+09
      C(296)=  0.21479647181885895729064941406250000D+10
      C(297)=  0.84657428796483573913574218750000000D+10
      C(298)= -0.21490484368833179473876953125000000D+10
      C(299)= -0.29409801009061422348022460937500000D+10
      C(300)= -0.35807941012229504585266113281250000D+10
      C(301)= -0.13217170391053803265094757080078125D+09
      C(302)= -0.33119549768688826560974121093750000D+10
      C(303)=  0.11072641471783638000488281250000000D+10
      C(304)=  0.59729204721547069549560546875000000D+10
      C(305)=  0.24301106622125844955444335937500000D+10
      C(306)=  0.60528999762749652862548828125000000D+10
      C(307)=  0.34817446629340958595275878906250000D+10
      C(308)= -0.96537583556559586524963378906250000D+09
      C(309)= -0.22665418257429227828979492187500000D+10
      C(310)= -0.13141946680428707599639892578125000D+10
      C(311)= -0.53187007970465898513793945312500000D+10
      C(312)= -0.57676039367315177917480468750000000D+10
      C(313)= -0.14617381779501049518585205078125000D+10
      C(314)=  0.76925389755395803451538085937500000D+10
      C(315)=  0.18192895583581566810607910156250000D+10
      C(316)=  0.80019985646379923820495605468750000D+09
      C(317)=  0.46622784156100912094116210937500000D+10
      C(318)=  0.24874025366242361068725585937500000D+10
      C(319)= -0.15860360588306567668914794921875000D+10
      C(320)=  0.56068929423858456313610076904296875D+08
      C(321)=  0.23061321273881216049194335937500000D+10
      C(322)=  0.11884906793692755699157714843750000D+10
      C(323)=  0.84579364301366195678710937500000000D+10
      C(324)=  0.53493400296641950607299804687500000D+10
      C(325)= -0.11718216876423892974853515625000000D+10
      C(326)= -0.21247120183247547149658203125000000D+10
      C(327)=  0.11491660435560934543609619140625000D+10
      C(328)=  0.76747584373339147567749023437500000D+10
      C(329)=  0.22911722397341747283935546875000000D+10
      C(330)= -0.68054921631320536136627197265625000D+09
      C(331)=  0.56481762887356364727020263671875000D+09
      C(332)=  0.17594597787609038352966308593750000D+10
      C(333)=  0.10813712970416424274444580078125000D+10
      C(334)= -0.76320032667179358005523681640625000D+09
      C(335)= -0.20663515567504024505615234375000000D+10
      C(336)= -0.57219102220278034210205078125000000D+10
      C(337)= -0.88082331439459877014160156250000000D+10
      C(338)=  0.38283026189530391693115234375000000D+10
      C(339)= -0.20595603937434563636779785156250000D+10
      C(340)=  0.44176810269548826217651367187500000D+10
      C(341)= -0.54653277309580659866333007812500000D+10
      C(342)= -0.20643761075059292316436767578125000D+10
      C(343)= -0.46941132509276466369628906250000000D+10
      C(344)= -0.25045954986142196655273437500000000D+10
      C(345)= -0.13545277381808515548706054687500000D+11
      C(346)= -0.11137226958947868347167968750000000D+11
      C(347)=  0.96042682712546133995056152343750000D+09
      C(348)=  0.46978681260694134235382080078125000D+09
      C(349)=  0.12450843028776955604553222656250000D+10
      C(350)=  0.74743015814991450309753417968750000D+09
      C(351)=  0.11481815934042224884033203125000000D+10
      C(352)=  0.27083288829241790771484375000000000D+10
      C(353)=  0.58757959862065362930297851562500000D+10
      C(354)= -0.23194769917030124664306640625000000D+10
      C(355)= -0.10070226355486141204833984375000000D+11
      C(356)= -0.92131513760021934509277343750000000D+10
      C(357)= -0.71007058805706310272216796875000000D+10
      C(358)=  0.12910604459657056331634521484375000D+10
      C(359)= -0.31498674767080779075622558593750000D+10
      C(360)= -0.20588527965832889080047607421875000D+10
      C(361)=  0.85117204629715127944946289062500000D+10
      C(362)=  0.11444939942657087326049804687500000D+11
      C(363)=  0.44616308100224971771240234375000000D+10
      C(364)= -0.19517287194463327527046203613281250D+09
      C(365)= -0.91556146479629945755004882812500000D+09
      C(366)= -0.42025438151490101814270019531250000D+10
      C(367)=  0.71652709367601318359375000000000000D+10
      C(368)=  0.98343639416199550628662109375000000D+10
      C(369)=  0.39041643907485566139221191406250000D+10
      C(370)= -0.18877580000394008159637451171875000D+10
      C(371)= -0.30742109900949172973632812500000000D+10
      C(372)= -0.23908304981608614921569824218750000D+10
      C(373)=  0.97507916390767650604248046875000000D+10
      C(374)=  0.63710184102193994522094726562500000D+10
      C(375)=  0.16583832243836407661437988281250000D+10
      C(376)=  0.36756146147805202007293701171875000D+09
      C(377)=  0.19296099649966554641723632812500000D+10
      C(378)=  0.56296691833276071548461914062500000D+10
      C(379)=  0.52438259335775108337402343750000000D+10
      C(380)=  0.66984730325767021179199218750000000D+10
      C(381)=  0.77945123029923868179321289062500000D+10
      C(382)=  0.72385095333325777053833007812500000D+10
      C(383)=  0.72014616551406764984130859375000000D+10
      C(384)=  0.65386782626702413558959960937500000D+10
      C(385)=  0.54604130577872934341430664062500000D+10
      C(386)= -0.92439087419031639099121093750000000D+10
      C(387)= -0.92828189646766510009765625000000000D+10
      C(388)= -0.99834875659522342681884765625000000D+10
      C(389)=  0.24240973475920615196228027343750000D+10
      C(390)= -0.83434148524330163002014160156250000D+09
      C(391)=  0.64876649957417020797729492187500000D+10
      C(392)= -0.10121850086265367507934570312500000D+11
      C(393)= -0.16678080792124258041381835937500000D+11
      C(394)= -0.77873414337784852981567382812500000D+10
      C(395)= -0.17281547793517124652862548828125000D+10
      C(396)= -0.40562632603765964508056640625000000D+10
      C(397)= -0.11811313486465747833251953125000000D+11
      C(398)= -0.65658223422060203552246093750000000D+10
      C(399)=  0.12416080818763768672943115234375000D+10
      C(400)=  0.59829167290116472244262695312500000D+10
      C(401)=  0.12828490935800157546997070312500000D+11
      C(402)=  0.83044539263585624694824218750000000D+10
      C(403)= -0.20134327571932825446128845214843750D+09
      C(404)= -0.47719303547475099563598632812500000D+10
      C(405)= -0.72002310201609182357788085937500000D+10
      C(406)= -0.11525203241477464675903320312500000D+11
      C(407)= -0.11999256442388715744018554687500000D+11
      C(408)= -0.11126218980275371551513671875000000D+11
      C(409)=  0.16181247061974196434020996093750000D+10
      C(410)=  0.12956545635300237655639648437500000D+11
      C(411)=  0.12841208819151809692382812500000000D+11
      C(412)=  0.86635238608208999633789062500000000D+10
      C(413)=  0.36710847258791856765747070312500000D+10
      C(414)=  0.10353399903819429874420166015625000D+10
      C(415)= -0.13032274570807081222534179687500000D+11
      C(416)= -0.45521109142780284881591796875000000D+10
      C(417)=  0.19178769676849596500396728515625000D+10
      C(418)=  0.13050328668164281845092773437500000D+10
      C(419)= -0.26685572442587757110595703125000000D+10
      C(420)= -0.41890526491472024917602539062500000D+10
      C(421)= -0.44281512041309099197387695312500000D+10
      C(422)= -0.12884574757530164718627929687500000D+10
      C(423)= -0.10970555509874942302703857421875000D+10
      C(424)= -0.41935680529681077003479003906250000D+10
      C(425)= -0.35021987292506599426269531250000000D+10
      C(426)= -0.27552183671051729470491409301757812D+08
      C(427)=  0.27022654326487689018249511718750000D+10
      C(428)=  0.34660301390065275132656097412109375D+08
      C(429)=  0.25761295401785278320312500000000000D+10
      C(430)=  0.85134644961920080184936523437500000D+10
      C(431)=  0.14865827126861120223999023437500000D+11
      C(432)=  0.11401828310040145874023437500000000D+11
      C(433)=  0.20024512258443489074707031250000000D+11
      C(434)=  0.23910439401531997680664062500000000D+11
      C(435)=  0.25479923501647968292236328125000000D+11
      C(436)=  0.90152978959506726264953613281250000D+09
      C(437)= -0.74480644603744039535522460937500000D+10
      C(438)= -0.21224746240985340118408203125000000D+11
      C(439)= -0.82174362073785429000854492187500000D+10
      C(440)=  0.96247161155411510467529296875000000D+10
      C(441)=  0.56792916838856697082519531250000000D+09
      C(442)=  0.19078606345561332702636718750000000D+11
      C(443)=  0.10787208416732019424438476562500000D+11
      C(444)=  0.46681572546699981689453125000000000D+10
      C(445)=  0.35837349215085053443908691406250000D+10
      C(446)=  0.29590911754095363616943359375000000D+09
      C(447)= -0.31445182566994256973266601562500000D+10
      C(448)= -0.18049100671093631744384765625000000D+11
      C(449)= -0.69156783618597211837768554687500000D+10
      C(450)=  0.31342495585592212677001953125000000D+10
      C(451)=  0.21846578988483529090881347656250000D+10
      C(452)=  0.54469956310176944732666015625000000D+10
      C(453)=  0.66614568176039609909057617187500000D+10
      C(454)=  0.12693232746869630813598632812500000D+11
      C(455)=  0.17311808671127285003662109375000000D+11
      C(456)=  0.12202893080568120956420898437500000D+11
      C(457)=  0.81672926475108480453491210937500000D+10
      C(458)= -0.15302978713818372726440429687500000D+11
      C(459)= -0.79988957555805768966674804687500000D+10
      C(460)= -0.12825719806466243743896484375000000D+11
      C(461)= -0.14441946684740739822387695312500000D+11
      C(462)= -0.41817935734573416709899902343750000D+10
      C(463)=  0.69019948115047025680541992187500000D+10
      C(464)=  0.16572980394694677352905273437500000D+11
      C(465)=  0.18455303378227001190185546875000000D+11
      C(466)=  0.16351502666596151351928710937500000D+11
      C(467)= -0.38225807565301666259765625000000000D+10
      C(468)= -0.10661883369354042053222656250000000D+11
      C(469)= -0.14930794632438335418701171875000000D+11
      C(470)= -0.14361035399832235336303710937500000D+11
      C(471)= -0.10648337839288080215454101562500000D+11
      C(472)= -0.48690119434567260742187500000000000D+10
      C(473)=  0.25426970432167163491249084472656250D+09
      C(474)=  0.25313095840285768508911132812500000D+10
      C(475)= -0.15515153218158290863037109375000000D+11
      C(476)= -0.18233612093453704833984375000000000D+11
      C(477)= -0.17884145867607318878173828125000000D+11
      C(478)= -0.14622257043222166061401367187500000D+11
      C(479)= -0.57547234528002777099609375000000000D+10
      C(480)=  0.23398533425054793357849121093750000D+10
      C(481)= -0.14944801248047021865844726562500000D+11
      C(482)= -0.10700371809040378570556640625000000D+11
      C(483)= -0.36266205882670884132385253906250000D+10
      C(484)=  0.72088526711367835998535156250000000D+10
      C(485)=  0.13802300931340042114257812500000000D+11
      C(486)= -0.31669921990839881896972656250000000D+10
      C(487)=  0.57603321493242330551147460937500000D+10
      C(488)=  0.13622822937769912719726562500000000D+11
      C(489)=  0.12063515329555929183959960937500000D+11
      C(490)=  0.14437856000719160079956054687500000D+11
      C(491)= -0.14760299685815034866333007812500000D+11
      C(492)=  0.21936591035631374359130859375000000D+11
      C(493)= -0.90549543586756362915039062500000000D+10
      C(494)=  0.11291225564325105667114257812500000D+11
      C(495)=  0.20353619340808235168457031250000000D+11
      C(496)= -0.96294440080381374359130859375000000D+10
      C(497)=  0.10243180657182651519775390625000000D+11
      C(498)=  0.14895259084475229263305664062500000D+11
      C(499)=  0.27202162329417945861816406250000000D+11
      C(500)=  0.31946273367741992950439453125000000D+11
      C(501)=  0.14399665635188507080078125000000000D+11
      C(502)=  0.29004114936012201309204101562500000D+10
      C(503)=  0.86737295471153850555419921875000000D+10
      C(504)=  0.10653003305656838417053222656250000D+10
      C(505)=  0.12106796211012262344360351562500000D+11
      C(506)=  0.13346489391716659545898437500000000D+11
      C(507)=  0.15387980475259098410606384277343750D+09
      C(508)= -0.16773217521465967178344726562500000D+11
      C(509)= -0.23104058025539321899414062500000000D+11
      C(510)= -0.45276494465572175979614257812500000D+10
      C(511)=  0.19423883261957706451416015625000000D+11
      C(512)=  0.25583660516577384948730468750000000D+11
      C(513)=  0.22584044624391468048095703125000000D+11
      C(514)=  0.82959226360478460788726806640625000D+09
      C(515)=  0.18913564196818546295166015625000000D+11
      C(516)=  0.11531062096148506164550781250000000D+11
      C(517)= -0.17592976537832515716552734375000000D+11
      C(518)= -0.24686106465696937561035156250000000D+11
      C(519)= -0.13753469113301588058471679687500000D+11
      C(520)=  0.19486136958942997455596923828125000D+10
      C(521)=  0.13829815186719898223876953125000000D+11
      C(522)=  0.17772556639452568054199218750000000D+11
      C(523)=  0.19847131791067153930664062500000000D+11
      C(524)=  0.42355115568719055175781250000000000D+11
      C(525)=  0.11409776891755271911621093750000000D+11
      C(526)= -0.15028559524753326416015625000000000D+11
      C(527)= -0.19185809483855381011962890625000000D+11
      C(528)= -0.17224672073118644714355468750000000D+11
      C(529)= -0.12422170437613027572631835937500000D+11
      C(530)= -0.49110110696937417984008789062500000D+10
      C(531)=  0.27211022048449511528015136718750000D+10
      C(532)= -0.85997635093258285522460937500000000D+10
      C(533)= -0.12385393289579854965209960937500000D+11
      C(534)= -0.11895596959652784347534179687500000D+11
      C(535)= -0.13174593148240320205688476562500000D+11
      C(536)= -0.12128206695713651657104492187500000D+11
      C(537)= -0.29184602928543334007263183593750000D+10
      C(538)=  0.19526989292831890583038330078125000D+10
      C(539)= -0.35539579302057251930236816406250000D+10
      C(540)= -0.20183597846665101051330566406250000D+10
      C(541)= -0.79943613652315683364868164062500000D+10
      C(542)= -0.86553518027239513397216796875000000D+10
      C(543)= -0.21559956925856595039367675781250000D+10
      C(544)= -0.77560237997154283523559570312500000D+10
      C(545)= -0.17122858966736886978149414062500000D+11
      C(546)= -0.21339615557354515075683593750000000D+11
      C(547)= -0.22563123511786376953125000000000000D+11
      C(548)= -0.32929908675397731781005859375000000D+11
      C(549)= -0.41255466055640869140625000000000000D+11
      C(550)= -0.50848755173315071105957031250000000D+11
      C(551)= -0.32559835044221904754638671875000000D+11
      C(552)=  0.56827530587693931579589843750000000D+11
      C(553)=  0.27187292199056156158447265625000000D+11
      C(554)=  0.31827240569626850128173828125000000D+11
      C(555)=  0.28306235430279922485351562500000000D+11
      C(556)= -0.24672768730573413848876953125000000D+11
      C(557)= -0.23421656318018432617187500000000000D+11
      C(558)= -0.27779282954501075744628906250000000D+11
      C(559)= -0.71620842432528038024902343750000000D+10
      C(560)=  0.49057980449540395736694335937500000D+10
      C(561)= -0.94375232180306110382080078125000000D+10
      C(562)= -0.24065869556524162292480468750000000D+11
      C(563)=  0.15300492394535919189453125000000000D+11
      C(564)=  0.34084901622127128601074218750000000D+11
      C(565)=  0.24772320683377044677734375000000000D+11
      C(566)=  0.92386373181695632934570312500000000D+10
      C(567)=  0.10527672948595633506774902343750000D+10
      C(568)= -0.23335105161957103729248046875000000D+11
      C(569)= -0.44640673990320251464843750000000000D+11
      C(570)= -0.44914798319682250976562500000000000D+11
      C(571)= -0.44681948851633186340332031250000000D+11
      C(572)= -0.40439844935843101501464843750000000D+11
      C(573)= -0.26958076733348808288574218750000000D+11
      C(574)= -0.18240072478394203186035156250000000D+11
      C(575)=  0.33705032490722411870956420898437500D+09
      C(576)=  0.28630419782808116912841796875000000D+11
      C(577)=  0.37774756707815925598144531250000000D+11
      C(578)= -0.32574028884986734390258789062500000D+10
      C(579)= -0.50993896844836044311523437500000000D+10
      C(580)=  0.23656814932368330955505371093750000D+10
      C(581)= -0.15460361446042482376098632812500000D+11
      C(582)= -0.45595134664349006652832031250000000D+11
      C(583)= -0.51870522926684188842773437500000000D+11
      C(584)= -0.38043243079560447692871093750000000D+11
      C(585)=  0.82122195338144119262695312500000000D+11
      C(586)=  0.29297377870906669616699218750000000D+11
      C(587)=  0.67368275818320074081420898437500000D+10
      C(588)=  0.26673930068820346832275390625000000D+11
      C(589)=  0.24364238222994041442871093750000000D+11
      C(590)= -0.14259531128624031066894531250000000D+11
      C(591)= -0.42531209811084632873535156250000000D+11
      C(592)= -0.41614916802265396118164062500000000D+11
      C(593)= -0.33600574317216957092285156250000000D+11
      C(594)=  0.61678940875170934200286865234375000D+09
      C(595)=  0.23431706500278381347656250000000000D+11
      C(596)=  0.51800359350023185729980468750000000D+11
      C(597)=  0.35723595710052009582519531250000000D+11
      C(598)= -0.39632417773135123252868652343750000D+10
      C(599)= -0.20978144603538612365722656250000000D+11
      C(600)= -0.13236314312235338211059570312500000D+11
      C(601)=  0.60961050121047805786132812500000000D+11
      C(602)=  0.69210930544651016235351562500000000D+11
      C(603)=  0.35267472323519805908203125000000000D+11
      C(604)=  0.22116621882629647254943847656250000D+10
      C(605)= -0.71366377759033327102661132812500000D+10
      C(606)= -0.33008458506970586776733398437500000D+10
      C(607)=  0.47947062278971519470214843750000000D+11
      C(608)=  0.66221646133852472305297851562500000D+10
      C(609)= -0.22289370464064762115478515625000000D+11
      C(610)= -0.29733196269746158599853515625000000D+11
      C(611)= -0.32153765311778717041015625000000000D+11
      C(612)= -0.57248650867434097290039062500000000D+11
      C(613)= -0.65047063059046371459960937500000000D+11
      C(614)= -0.83631385852988708496093750000000000D+11
      C(615)=  0.46723527524763450622558593750000000D+11
      C(616)= -0.73392833569782592773437500000000000D+11
      C(617)= -0.57457247345311536788940429687500000D+10
      C(618)= -0.30141287310286464691162109375000000D+11
      C(619)= -0.39041463665337600708007812500000000D+10
      C(620)= -0.13484688977369722366333007812500000D+11
      C(621)=  0.14397644007425241470336914062500000D+10
      C(622)=  0.36482751819720273017883300781250000D+10
      C(623)=  0.17907631055077102661132812500000000D+11
      C(624)= -0.88302526257060508728027343750000000D+10
      C(625)= -0.33003947643818664550781250000000000D+11
      C(626)= -0.48883317748306989669799804687500000D+10
      C(627)=  0.20237680098232929229736328125000000D+11
      C(628)= -0.33412665752509445190429687500000000D+11
      C(629)=  0.37012195553755165100097656250000000D+11
      C(630)= -0.17259707203836975097656250000000000D+11
      C(631)= -0.54629294501854362487792968750000000D+11
      C(632)= -0.24359575694092960357666015625000000D+11
      C(633)=  0.95701772326266689300537109375000000D+10
      C(634)=  0.58391258047756324768066406250000000D+11
      C(635)=  0.71215635675674392700195312500000000D+11
      C(636)=  0.75811199449443855285644531250000000D+10
      C(637)= -0.51081353095715278625488281250000000D+11
      C(638)= -0.10688550356364038467407226562500000D+11
      C(639)=  0.70797865103667739868164062500000000D+11
      C(640)= -0.57994110838308593750000000000000000D+11
      C(641)= -0.14379329715694711685180664062500000D+11
      C(642)= -0.19365743360426586866378784179687500D+09
      C(643)= -0.45783305953580024719238281250000000D+11
      C(644)=  0.33995742495059165954589843750000000D+11
      C(645)=  0.11221823410868426513671875000000000D+12
      C(646)=  0.74135198482419616699218750000000000D+11
      C(647)= -0.29983574342784122467041015625000000D+11
      C(648)= -0.52438654358645805358886718750000000D+11
      C(649)=  0.25313030665128509521484375000000000D+11
      C(650)=  0.78963327882229492187500000000000000D+11
      C(651)=  0.37052510030351493835449218750000000D+11
      C(652)= -0.80361256691675888061523437500000000D+11
      C(653)= -0.69333538611392547607421875000000000D+11
      C(654)=  0.45447889539703475952148437500000000D+11
      C(655)=  0.75640760551268783569335937500000000D+11
      C(656)= -0.11905033264813524246215820312500000D+11
      C(657)= -0.78906478416491485595703125000000000D+11
      C(658)= -0.27697655950474822998046875000000000D+11
      C(659)=  0.64828912477510269165039062500000000D+11
      C(660)= -0.13299169808222709655761718750000000D+12
      C(661)= -0.39138293749364822387695312500000000D+11
      C(662)=  0.46967512667982856750488281250000000D+11
      C(663)=  0.13611203500098714828491210937500000D+11
      C(664)= -0.72279311905257293701171875000000000D+11
      C(665)= -0.63277499512562705993652343750000000D+11
      C(666)=  0.37283157368680900573730468750000000D+11
      C(667)=  0.98077084301931564331054687500000000D+11
      C(668)=  0.35937960813261207580566406250000000D+11
      C(669)=  0.42329128937383178710937500000000000D+11
      C(670)= -0.32277231956796165466308593750000000D+11
      C(671)= -0.67458035232277946472167968750000000D+11
      C(672)=  0.61790052997087383270263671875000000D+10
      C(673)=  0.10484197797148123168945312500000000D+12
      C(674)= -0.12534032868783617019653320312500000D+11
      C(675)= -0.64163438998452957153320312500000000D+11
      C(676)= -0.31573792976147541046142578125000000D+11
      C(677)=  0.65088689950257904052734375000000000D+11
      C(678)=  0.11797114548609614562988281250000000D+12
      C(679)= -0.50182325174157485961914062500000000D+11
      C(680)=  0.18674182567622436523437500000000000D+11
      C(681)=  0.86884998984459686279296875000000000D+11
      C(682)=  0.66447314197655746459960937500000000D+11
      C(683)=  0.86329026743091827392578125000000000D+11
      C(684)=  0.13005540698733339954884513645083643D+01
      C(685)= -0.16675591338641815308818650009925477D+01
      C(686)= -0.26697296717423255269299731118337604D-03
      C(687)=  0.20027638147383108879751034692162648D+01
      C(688)=  0.20781788900993480861956186345196329D+00
      C(689)= -0.13889642211062784848962792239035480D+01
      C(690)=  0.51129671309994531580578325247188332D-01
      C(691)=  0.73805737284616243498724941218824824D-01
      C(692)=  0.17172432069576512581043914451583987D+00
      C(693)= -0.86328046790523967501940205693244934D+04
      C(694)=  0.72961119147232500470323657282278873D+00
      C(695)=  0.83072660362130590350204784044763073D+00
      C(696)=  0.34958750804475524631698135635815561D+01
      C(697)=  0.64898836165222550942388579642283730D+00
      C(698)=  0.21288163254629666187867087501217611D+00
      C(699)=  0.57916389643633825468072018338716589D+00
      C(700)=  0.20134984417447228111086587887257338D+01
      C(701)=  0.17583221848959567079617727358709089D+01
      C(702)=  0.10481229489875456550862509175203741D+01
      C(703)=  0.41884467370969724608897877260460518D+00
      C(704)=  0.11798238408873515936647891066968441D+01
      C(705)=  0.12254044298356654429937862005317584D+01

      BSORDER(1)= 10

      POLORDER=  26

      DO I=1,DEG
        NCBAS(I)=0
        NCBAS(I)=2*BSORDER(I)+2
      END DO

      CALL POLNC(POLORDER,MOLTYP,NCPOL)

      IF (NC.NE.(NCPOL+SUM(NCBAS))) THEN 
        WRITE(*,*) "PROBLEMS IN DEFINING PROPER NUMBER OF COEFFICIENTS"
        WRITE(*,*) "TOTAL NUMBER OF COEFFS ARE NOT SUMMING UP CORRECTLY"
        STOP
      END IF

      ALLOCATE(POL(NCPOL))
      ALLOCATE(DVDY1(NCPOL),DVDY2(NCPOL),DVDY3(NCPOL))

      DO I=1,NCPOL
        POL(I)=0.00D+00
        DVDY1(I)=0.00D+00
        DVDY2(I)=0.00D+00
        DVDY3(I)=0.00D+00
      END DO

      DO I=1,NX
        Y(I)=0.0D+00
        DYDR(I)=0.0D+00
        DVDR(I)=0.0D+00
      END DO

      SUMC=NCPOL
      DO I=1,DEG
        ALLOCATE(BS(NCBAS(I)))
        DO J=1,NCBAS(I)
          BS(J)=0.0D+00
        END DO
        K=SUMC
        DO J=1,NCBAS(I)
          K=K+1
          BS(J)=C(K)
        END DO

!######
! A3-TYPE
!######
        IF (DEG.EQ.1) THEN
          DO O=1,3 
            CALL BASIS_CONTRACT(1,BSORDER(1),BS,R(O),Y(O))

!###### CALCULATING ANALYTIC DERIVATIVES OF Y WITH RESPECT TO R IF DER=.TRUE.
            
            IF (DER) THEN
              CALL DBASIS_CONTRACT(1,BSORDER(1),BS,R(O),DYDR(O))
            END IF

!######
          END DO
        END IF

        SUMC=SUMC+NCBAS(I)
        DEALLOCATE(BS)
      END DO

      TOTNUM=0
      S=0
      DO M=0,POLORDER
        MNUM=0
        DO I=0,M
          DO J=0,(M-I)
            K=M-I-J
            S=I+J+K
            IF (S.NE.I .AND. S.NE.J .AND. S.NE.K) THEN

              IF (MOLTYP.EQ."ABC") THEN  

                TOTNUM=TOTNUM+1
                MNUM=MNUM+1

                CALL PERMUTABC(I,J,K,P,ID)

                DO L=1,ID

                  POL(TOTNUM)=POL(TOTNUM)+&
     &               (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                END DO

                POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                IF (DER) THEN
                  DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                  DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                  DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                END IF

!######
              ELSE IF (MOLTYP.EQ."AB2") THEN 

                IF (J.LE.K) THEN 

                  TOTNUM=TOTNUM+1
                  MNUM=MNUM+1

                  CALL PERMUTAB2(I,J,K,P,ID)
                   
                  DO L=1,ID

                    POL(TOTNUM)=POL(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                  END DO

                  POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                  IF (DER) THEN
                    DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                    DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                    DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                  END IF

!######
                END IF    
         
              ELSE IF (MOLTYP.EQ."A3") THEN

                IF (I.LE.J .AND. J.LE.K) THEN

                  TOTNUM=TOTNUM+1
                  MNUM=MNUM+1

                  CALL PERMUTA3(I,J,K,P,ID)
                   
                  DO L=1,ID

                    POL(TOTNUM)=POL(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*Y(3)**(P(3,L)))

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO Y IF DER=.TRUE.

                      IF (DER) THEN
             
                        DVDY1(TOTNUM)=DVDY1(TOTNUM)+&
     &                 (DBLE(P(1,L))*Y(1)**(P(1,L)-1)*Y(2)**(P(2,L))*Y(3)**(P(3,L))) 

                        DVDY2(TOTNUM)=DVDY2(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*DBLE(P(2,L))*Y(2)**(P(2,L)-1)*Y(3)**(P(3,L)))    

                        DVDY3(TOTNUM)=DVDY3(TOTNUM)+&
     &                 (Y(1)**(P(1,L))*Y(2)**(P(2,L))*DBLE(P(3,L))*Y(3)**(P(3,L)-1)) 
             
                      END IF

!######
                  END DO

                  POL(TOTNUM)=C(TOTNUM)*POL(TOTNUM)/DBLE(ID)

!###### MULTIPLYING THE CONTRIBUTIONS OF DVDY BY THE POLYNOMIAL COEFFS. IF DER=.TRUE.

                  IF (DER) THEN
                    DVDY1(TOTNUM)=C(TOTNUM)*DVDY1(TOTNUM)/DBLE(ID)
                    DVDY2(TOTNUM)=C(TOTNUM)*DVDY2(TOTNUM)/DBLE(ID)
                    DVDY3(TOTNUM)=C(TOTNUM)*DVDY3(TOTNUM)/DBLE(ID)
                  END IF

!######
                END IF

              END IF

            END IF
          END DO
        END DO

      END DO

      POT=SUM(POL)*REPDAMP(NX,R)

!###### CALCULATING ANALYTIC DERIVATIVES OF V WITH RESPECT TO R IF DER=.TRUE.

      IF (DER) THEN
        DVDR(1)=SUM(DVDY1)*DYDR(1)
        DVDR(2)=SUM(DVDY2)*DYDR(2)
        DVDR(3)=SUM(DVDY3)*DYDR(3)
      ELSE 
        DVDR(1)=1000
        DVDR(2)=1000
        DVDR(3)=1000
      END IF

!######

      DEALLOCATE(POL)
      DEALLOCATE(DVDY1,DVDY2,DVDY3)

      RETURN
      END

!####################################################################################

      SUBROUTINE CARTDERPES3BD(X,DVDX)
      IMPLICIT NONE 
      INTEGER :: I
      INTEGER, PARAMETER :: NATOM=3     
      DOUBLE PRECISION, DIMENSION(3*NATOM) :: X
      DOUBLE PRECISION, DIMENSION(3*NATOM) :: DVDX,O
      DOUBLE PRECISION, DIMENSION(NATOM) :: Y,R,DVDR
      DOUBLE PRECISION :: V
!
!     This subprogram uses the chain rule to calculate the derivatives of the
!     energy with respect to the cartesian coordinates from the derivatives
!     with respect to the internal coordinates for a three-body system.
!     The convention assumed in this program is as follows:
!
!     R(1) = R(A-B)
!     R(2) = R(A-C)
!     R(3) = R(B-C)
!     X(1) - X(3) : X, Y, Z for atom A
!     X(4) - X(6) : X, Y, Z for atom B
!     X(7) - X(9) : X, Y, Z for atom C
!
      CALL CART2INTER3BD(X,O,3*NATOM)

      R(1)=O(1)
      R(2)=O(2)
      R(3)=O(3)

      CALL CHIPR_TRIAT(R,V,.TRUE.,DVDR) 

      DO I=1,3
        Y(I)=DVDR(I)/R(I)
      END DO

      DVDX(1)=-Y(1)*(X(4)-X(1))-Y(2)*(X(7)-X(1)) 
      DVDX(2)=-Y(1)*(X(5)-X(2))-Y(2)*(X(8)-X(2)) 
      DVDX(3)=-Y(1)*(X(6)-X(3))-Y(2)*(X(9)-X(3)) 
      DVDX(4)= Y(1)*(X(4)-X(1))-Y(3)*(X(7)-X(4)) 
      DVDX(5)= Y(1)*(X(5)-X(2))-Y(3)*(X(8)-X(5))
      DVDX(6)= Y(1)*(X(6)-X(3))-Y(3)*(X(9)-X(6))
      DVDX(7)= Y(2)*(X(7)-X(1))+Y(3)*(X(7)-X(4))
      DVDX(8)= Y(2)*(X(8)-X(2))+Y(3)*(X(8)-X(5))
      DVDX(9)= Y(2)*(X(9)-X(3))+Y(3)*(X(9)-X(6))

      RETURN
      END

!####################################################################################

      SUBROUTINE CART2INTER3BD(X,R,NTA)
      IMPLICIT NONE
      INTEGER, PARAMETER :: NA=3,NT=3*NA
      INTEGER :: NTA,I,K,J
      DOUBLE PRECISION, DIMENSION (NT):: X,R
      K=0
      DO I=1,NTA,3
       DO J=I,NTA,3
        IF(I.NE.J)THEN
         K=K+1
         R(K)=SQRT((X(I)-X(J))**2+(X(I+1)-X(J+1))**2+&
     &   (X(I+2)-X(J+2))**2)
        END IF
       END DO
      END DO
      RETURN
      END

!################################################################################

      DOUBLE PRECISION FUNCTION REPDAMP(NX,R)
      IMPLICIT NONE
      INTEGER :: I,NX
      DOUBLE PRECISION, DIMENSION(NX) :: R,H
      DOUBLE PRECISION :: KAPPA, XI, R0
      R0=0.5D+00
      KAPPA=100.0D+00
      XI=10.0D+00
      DO I=1,NX
        H(I)=0.5D+00*(1.00D+00+TANH(KAPPA*(R(I)-R0)))
      END DO
      REPDAMP=(PRODUCT(H))**(XI)      
      END FUNCTION

!################################################################################      
      
      SUBROUTINE PERMUTABC(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO

      INTER(1)=I
      INTER(2)=J
      INTER(3)=K

      ID=1

      P(1,1)=INTER(1)
      P(2,1)=INTER(2)
      P(3,1)=INTER(3) 

      RETURN
      END

!################################################################################      
      
      SUBROUTINE PERMUTAB2(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO
      
      INTER(1)=I
      INTER(2)=J
      INTER(3)=K
      
      IF (J.NE.K) THEN  
 
        ID=2

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(1)
        P(2,2)=INTER(3)
        P(3,2)=INTER(2) 

       ELSE 

        ID=1

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)

       END IF

      RETURN 
      END 

!################################################################################      
      
      SUBROUTINE PERMUTA3(I,J,K,P,ID)
      IMPLICIT NONE
      INTEGER :: I,J,K
      INTEGER :: L,M,ID
      INTEGER, DIMENSION(3) :: INTER
      INTEGER, DIMENSION(3,6) :: P

      DO L=1,3 
        DO M=1,6
          P(L,M)=0
        END DO
      END DO
      
      INTER(1)=I
      INTER(2)=J
      INTER(3)=K
      
      IF (I.EQ.J.AND.J.EQ.K.AND.I.EQ.K) THEN
      
        ID=1

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)  
        
      ELSE IF (I.NE.J.AND.J.NE.K.AND.I.NE.K) THEN   

        ID=6

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(3)
        P(2,3)=INTER(2)
        P(3,3)=INTER(1) 

        P(1,4)=INTER(1)
        P(2,4)=INTER(3)
        P(3,4)=INTER(2) 

        P(1,5)=P(1,2)
        P(2,5)=P(3,2)
        P(3,5)=P(2,2)  

        P(1,6)=P(1,3)
        P(2,6)=P(3,3)
        P(3,6)=P(2,3)  
        
      ELSE IF (I.EQ.J) THEN       
     
        ID=3     

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3) 

        P(1,2)=INTER(3)
        P(2,2)=INTER(2)
        P(3,2)=INTER(1) 

        P(1,3)=INTER(1)
        P(2,3)=INTER(3)
        P(3,3)=INTER(2)
        
      ELSE IF (J.EQ.K) THEN       
                    
        ID=3     

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(3)
        P(2,3)=INTER(2)
        P(3,3)=INTER(1) 
        
      ELSE IF (I.EQ.K) THEN    
  
        ID=3  

        P(1,1)=INTER(1)
        P(2,1)=INTER(2)
        P(3,1)=INTER(3)      

        P(1,2)=INTER(2)
        P(2,2)=INTER(1)
        P(3,2)=INTER(3)  

        P(1,3)=INTER(1)
        P(2,3)=INTER(3)
        P(3,3)=INTER(2)        
    
      END IF

      RETURN 
      END 

!################################################################################ 

      SUBROUTINE POLNC(ORDER,MOLTYP,NC)
      IMPLICIT NONE
      INTEGER :: I,J,K,L,M,S
      INTEGER :: NC,MNUM,ORDER
      CHARACTER(LEN=3) :: MOLTYP

      NC=0
      S=0

      DO M=0,ORDER
        MNUM=0
        DO I=0,M
          DO J=0,(M-I)
            K=M-I-J
            S=I+J+K
            IF (S.NE.I .AND. S.NE.J .AND. S.NE.K) THEN
 
              IF (MOLTYP.EQ."ABC") THEN  

                NC=NC+1
                MNUM=MNUM+1

              ELSE IF (MOLTYP.EQ."AB2") THEN 

                IF (J.LE.K) THEN 

                  NC=NC+1
                  MNUM=MNUM+1

                END IF    
        
              ELSE IF (MOLTYP.EQ."A3") THEN

                IF (I.LE.J .AND. J.LE.K) THEN

                  NC=NC+1
                  MNUM=MNUM+1

                END IF

              END IF

            END IF
          END DO
        END DO
      END DO

      RETURN
      END

!######################################################################################################

      SUBROUTINE BASIS_CONTRACT(DEG,M,C,R,YVAL)
      IMPLICIT NONE
      INTEGER :: I,J,DEG
      INTEGER :: M
      DOUBLE PRECISION :: RREF0,ZETA
      DOUBLE PRECISION, DIMENSION(2*M+2) :: C
      DOUBLE PRECISION, DIMENSION(M) :: GAMA,VAL
      DOUBLE PRECISION :: R,YVAL

      DO I=1,M
        GAMA(I)=C(M+I)
      END DO

      RREF0=C(2*M+1)
      ZETA=C(2*M+2)

      DO I=1,M-1
        CALL PHISECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,R,VAL(I))
      END DO

      DO I=M,M
        CALL PHICSECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,6,R,VAL(I))
      END DO

      YVAL=0.00D+00

      DO J=1,M
        YVAL=YVAL+C(J)*VAL(J)
      END DO

      RETURN
      END

!######################################################################################################

      SUBROUTINE PHISECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,R,VAL)
      IMPLICIT NONE
      INTEGER :: DEG, IND, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, ORIG
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      VAL=(SECH(GAMA*RHO))**(DBLE(ETA))
      RETURN
      END

!######################################################################################################

      SUBROUTINE PHICSECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,LR,R,VAL)
      IMPLICIT NONE
      INTEGER :: DEG, IND, LR, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, BETA, FAC, ORIG
      BETA=1.00D+00/5.0D+00
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      FAC=(TANH(BETA*R)/R)**(DBLE(LR))
      VAL=FAC*(SECH(GAMA*RHO))**(DBLE(ETA))
      RETURN
      END

!######################################################################################################

      SUBROUTINE DBASIS_CONTRACT(DEG,M,C,R,DYDR)
      IMPLICIT NONE
      INTEGER :: I,J,DEG
      INTEGER :: M
      DOUBLE PRECISION :: RREF0,ZETA
      DOUBLE PRECISION, DIMENSION(2*M+2) :: C
      DOUBLE PRECISION, DIMENSION(M) :: GAMA,DPHIDR
      DOUBLE PRECISION :: R,DYDR

      DO I=1,M
        GAMA(I)=C(M+I)
      END DO

      RREF0=C(2*M+1)
      ZETA=C(2*M+2)

      DO I=1,M-1
        CALL DPHISECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,R,DPHIDR(I))
      END DO

      DO I=M,M
        CALL DPHICSECBASIS(DEG,I,RREF0,ZETA,GAMA(I),1,6,R,DPHIDR(I))
      END DO

      DYDR=0.00D+00

      DO J=1,M
        DYDR=DYDR+C(J)*DPHIDR(J)
      END DO

      RETURN
      END

!######################################################################################################

      SUBROUTINE DPHISECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,R,DPHIDR)
      IMPLICIT NONE
      INTEGER :: DEG, IND, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, ORIG
      DOUBLE PRECISION :: PART1,PART2
      DOUBLE PRECISION :: DPHIDR
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      PART1=(SECH(GAMA*RHO))**(DBLE(ETA))
      PART2=(TANH(GAMA*RHO))
      DPHIDR=-(DBLE(ETA))*GAMA*PART1*PART2
      RETURN
      END

!######################################################################################################

      SUBROUTINE DPHICSECBASIS(DEG,IND,RREF0,ZETA,GAMA,ETA,LR,R,DPHIDR)
      IMPLICIT NONE
      INTEGER :: DEG, IND, LR, ETA
      DOUBLE PRECISION :: RREF0, ZETA, RREFIND 
      DOUBLE PRECISION :: GAMA, R, VAL, RHO
      DOUBLE PRECISION :: SECH, BETA, FAC, ORIG
      DOUBLE PRECISION :: FAC1PART1,FAC2PART1
      DOUBLE PRECISION :: FAC3PART1,FAC1PART2
      DOUBLE PRECISION :: FAC2PART2,FAC3PART2
      DOUBLE PRECISION :: PART1,PART2
      DOUBLE PRECISION :: DPHIDR
      BETA=1.00D+00/5.0D+00
      RREFIND=ORIG(IND,ZETA,RREF0)
      RHO=(R-RREFIND)
      FAC1PART1=(TANH(BETA*R)/R)**(DBLE(LR-1))
      FAC2PART1=(BETA*(SECH(BETA*R))**(2)/R)-(TANH(BETA*R)/R**2)
      FAC3PART1=(SECH(GAMA*RHO))**(DBLE(ETA))
      PART1=(DBLE(LR))*FAC1PART1*FAC2PART1*FAC3PART1
      FAC1PART2=(SECH(GAMA*RHO))**(DBLE(ETA))
      FAC2PART2=(TANH(GAMA*RHO))
      FAC3PART2=(TANH(BETA*R)/R)**(DBLE(LR))
      PART2=-(DBLE(ETA))*GAMA*FAC1PART2*FAC2PART2*FAC3PART2
      DPHIDR=PART1+PART2
      RETURN
      END

!######################################################################################################

      DOUBLE PRECISION FUNCTION ORIG(IND,ZETA,RREF0)
      IMPLICIT NONE
      INTEGER :: IND
      DOUBLE PRECISION :: ZETA,RREF0
      ORIG=ZETA*(RREF0)**(DBLE(IND)-1.0D+00)
      RETURN
      END

!######################################################################################################

      DOUBLE PRECISION FUNCTION SECH(X)
      IMPLICIT NONE
      DOUBLE PRECISION :: X
      SECH=1.00D+00/(COSH(X))      
      RETURN
      END
